<h2>Ticket ID: {{ ticket.ticket_id }}</h2>
<p>Status: {{ ticket.status }}</p>
<p><strong>User:</strong> {{ ticket.first_name }} {{ ticket.last_name }} ({{ ticket.username }})</p>
<p><strong>Email:</strong> {{ ticket.email }}</p>
<p><strong>IP Address:</strong> {{ ticket.ip_address }}</p>
<p><strong>Issue:</strong> {{ ticket.issue }}</p>

<h3>AI Suggested Steps:</h3>
<div id="ai-box">
  <div id="loading-area">
    <p id="loading-msg">ðŸ§  The assistant is thinking<span id="dots"></span></p>
    <progress id="ai-progress" max="100" value="20" style="width: 50%;"></progress>
  </div>
</div>

<hr>

<h3>Continue Chatting with the Assistant:</h3>
<input type="text" id="user-input" placeholder="Type your question..." style="width: 60%;">
<button onclick="sendMessage()">Send</button>

<div id="chat-response" style="margin-top: 10px;"></div>

{% if ticket.status != 'resolved' %}
<form action="{{ url_for('main.mark_resolved', ticket_id=ticket.ticket_id) }}" method="POST" style="margin-top: 20px;">
    <button type="submit">Mark as Resolved</button>
</form>
{% else %}
<p><strong>Status:</strong> âœ… This ticket has been marked as resolved.</p>
{% endif %}

<a href="/">Back to Home</a>

<script>
  const ticketId = "{{ ticket.ticket_id }}";
  const dots = document.getElementById("dots");
  const progressBar = document.getElementById("ai-progress");
  let dotCount = 0;
  let progress = 20;
  let dotInterval, progressInterval;

  // Animate dots (thinking...)
  dotInterval = setInterval(() => {
    dotCount = (dotCount + 1) % 4;
    dots.textContent = '.'.repeat(dotCount);
  }, 500);

  // Animate fake progress bar
  progressInterval = setInterval(() => {
    if (progress < 95) {
      progress += Math.random() * 5;
      progressBar.value = progress;
    }
  }, 400);

  // Get AI response on page load
  fetch(`/ticket/ai/${ticketId}`)
    .then(res => res.json())
    .then(data => {
      clearInterval(dotInterval);
      clearInterval(progressInterval);
      document.getElementById("ai-box").innerHTML = `<p>${data.response}</p>`;
    })
    .catch(err => {
      clearInterval(dotInterval);
      clearInterval(progressInterval);
      document.getElementById("ai-box").innerHTML = `<p style="color: red;">AI error: ${err}</p>`;
    });

  // Chat follow-up
  function sendMessage() {
    const userInput = document.getElementById("user-input").value;
    const responseBox = document.getElementById("chat-response");
    responseBox.innerHTML = "ðŸ§  The assistant is thinking...";

    fetch(`/ticket/ai/${ticketId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: userInput })
    })
    .then(res => res.json())
    .then(data => {
      responseBox.innerHTML = `<p><strong>Assistant:</strong> ${data.response}</p>`;
    })
    .catch(err => {
      responseBox.innerHTML = `<p style="color: red;">AI error: ${err}</p>`;
    });
  }
</script>
